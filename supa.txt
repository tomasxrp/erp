-- 1. Habilitar extensiones necesarias
create extension if not exists "uuid-ossp";

-- 2. ENUMS (Para restringir valores y evitar errores de tipeo)
create type user_role as enum ('admin', 'vendedor', 'bodeguero');
create type quote_status as enum ('borrador', 'enviada', 'aceptada', 'rechazada');
create type movement_type as enum ('entrada', 'salida', 'ajuste', 'venta');

-- ==========================================
-- 3. TABLA DE PERFILES (TRABAJADORES)
-- Se vincula automáticamente con el Login de Supabase
-- ==========================================
create table public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text,
  full_name text,
  role user_role default 'vendedor',
  avatar_url text,
  phone text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Habilitar seguridad
alter table public.profiles enable row level security;

-- ==========================================
-- 4. TABLA DE PRODUCTOS (INVENTARIO)
-- ==========================================
create table public.products (
  id uuid default uuid_generate_v4() primary key,
  sku text unique not null, -- Código de barras o identificador único
  name text not null,
  description text,
  price decimal(10,2) not null check (price >= 0),
  cost_price decimal(10,2) check (cost_price >= 0), -- Para calcular ganancias
  current_stock integer default 0,
  min_stock_alert integer default 5, -- Para alertas de stock bajo
  category text,
  image_url text,
  metadata jsonb default '{}'::jsonb, -- Aquí puedes guardar color, talla, peso sin cambiar la DB
  active boolean default true,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.products enable row level security;

-- ==========================================
-- 5. MOVIMIENTOS DE INVENTARIO (KARDEX)
-- Historial inmutable de qué entra y sale
-- ==========================================
create table public.stock_movements (
  id uuid default uuid_generate_v4() primary key,
  product_id uuid references public.products(id) on delete restrict not null,
  user_id uuid references public.profiles(id) not null, -- Quién hizo el movimiento
  quantity integer not null, -- Puede ser positivo (entrada) o negativo (salida)
  type movement_type not null,
  notes text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.stock_movements enable row level security;

-- ==========================================
-- 6. COTIZACIONES
-- ==========================================
create table public.quotes (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references public.profiles(id) not null, -- Vendedor
  client_name text not null,
  client_email text,
  client_rut text, -- O DNI
  total_amount decimal(10,2) default 0,
  status quote_status default 'borrador',
  valid_until date,
  notes text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.quotes enable row level security;

-- Items dentro de una cotización
create table public.quote_items (
  id uuid default uuid_generate_v4() primary key,
  quote_id uuid references public.quotes(id) on delete cascade not null,
  product_id uuid references public.products(id) on delete restrict,
  quantity integer not null check (quantity > 0),
  unit_price decimal(10,2) not null -- Guardamos el precio del momento, por si cambia el producto después
);

alter table public.quote_items enable row level security;

-- ==========================================
-- 7. VENTAS Y BOLETAS
-- ==========================================
create table public.sales (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references public.profiles(id) not null,
  customer_info jsonb default '{}'::jsonb, -- Guardamos datos del cliente snapshot
  total_amount decimal(10,2) not null,
  payment_method text, -- 'efectivo', 'tarjeta', 'transferencia'
  receipt_number text unique, -- Número de boleta/folio
  receipt_url text, -- PDF de la boleta si se genera
  receipt_data jsonb, -- Contenido crudo de la boleta para reconstruirla
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table public.sales enable row level security;

-- Detalle de la venta
create table public.sale_items (
  id uuid default uuid_generate_v4() primary key,
  sale_id uuid references public.sales(id) on delete cascade not null,
  product_id uuid references public.products(id),
  product_name text not null, -- Guardamos el nombre por si se borra el producto
  quantity integer not null,
  unit_price decimal(10,2) not null
);

alter table public.sale_items enable row level security;

-- ==========================================
-- 8. AUTOMATIZACIÓN (TRIGGERS)
-- Crear perfil automáticamente al registrarse
-- ==========================================
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, email, full_name, role)
  values (new.id, new.email, new.raw_user_meta_data->>'full_name', 'vendedor');
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- ==========================================
-- 9. POLÍTICAS DE SEGURIDAD (RLS BÁSICAS)
-- Por ahora, permitiremos que cualquier usuario autenticado lea y escriba.
-- En producción, deberías restringir 'delete' solo a admins.
-- ==========================================

-- Profiles: Todos pueden ver perfiles, solo el dueño puede editar su propio perfil
create policy "Ver perfiles" on profiles for select using (auth.role() = 'authenticated');
create policy "Editar propio perfil" on profiles for update using (auth.uid() = id);

-- Products: Todos ven y editan (para simplificar el ERP por ahora)
create policy "Acceso total productos" on products for all using (auth.role() = 'authenticated');

-- Quotes/Sales: Los usuarios ven todo (colaborativo)
create policy "Acceso total cotizaciones" on quotes for all using (auth.role() = 'authenticated');
create policy "Acceso total items cotizaciones" on quote_items for all using (auth.role() = 'authenticated');
create policy "Acceso total ventas" on sales for all using (auth.role() = 'authenticated');
create policy "Acceso total items ventas" on sale_items for all using (auth.role() = 'authenticated');
create policy "Acceso total movimientos" on stock_movements for all using (auth.role() = 'authenticated');